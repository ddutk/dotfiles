#!/bin/bash
#  Use calcure to print out events from a folder full of ICS files

ICSFILES="$HOME/Documents/Storage/Backup/Monthly/Calendar"
DAYS=5

DATE=/opt/local/bin/gdate
SED=/opt/local/bin/gsed
CALCURSE=/opt/local/bin/calcurse

rm -f ~/.calcurse/apts ~/.calcurse/imported.ics
for i in $ICSFILES/*.ics ; do
  $SED -e '/^ / !{h};/^ / {H;x;s/;.*:\r\n /:/g}' -e '/:\r$/ d' < $i >> ~/.calcurse/imported.ics
done
$CALCURSE -i ~/.calcurse/imported.ics 2>&1 > /dev/null

for ((i=1;i<=$DAYS;i++)) ; do
  j=$(echo $i'-1' | bc)
  day[$i]=$($DATE -d "$j days" +%D | $SED 's/\//\\\//g')
  dayname[$i]=$($DATE -d "$j days" +%A)
done

dayname[1]="Today"
dayname[2]="Tomorrow"

# Replace actual newlines with "^" for echo later
apptlist=$($CALCURSE -r$DAYS | $SED "s/\*/-/g" | $SED -e :a -e '$!N;s/\n/\^/;ta')

# Append all the date lines to the time lines
apptlist=$(echo "$apptlist" | $SED "s/\\( - [0-9][0-9]:[0-9][0-9] -> [0-9][0-9]:[0-9][0-9]\\)\^/\1:/g")

# Replace the arrows with dashes
apptlist=$(echo "$apptlist" | $SED "s/ -> /\xE2\x80\x93/g")

# Change the dashes to bullets
apptlist=$(echo "$apptlist" | $SED -e "s/\^ - /\^ \xE2\x80\xA2 /g")

for ((i=1;i<=$DAYS;i++)) ; do
  apptlist=$(echo "$apptlist" | $SED -e 's/'${day[$i]}':/'${dayname[$i]}':/')
done

currenthour=`$DATE "+%k"`
currentminute=`$DATE "+%M"`

OIFS=$IFS
IFS='^'
intoday=0
for x in $apptlist ; do
  if echo $x | grep -q ".*:$" ; then
    if [ "$x" = "Today:" ] ; then
      intoday=1
    else
      intoday=0
    fi
  fi
  
  if [ $intoday -eq 1 ] ; then
    # Look for a time in this event
    time=""
    if echo $x | grep -q "^ . [0-9][0-9]:[0-9][0-9].[0-9][0-9]:[0-9][0-9]" ; then
      time="${x:9:5}"
    elif echo $x | grep -q "^ . [0-9][0-9]:[0-9][0-9]" ; then
      time="${x:3:5}"
    fi
    
    if [ "$time" != "" ] ; then
      # If the end time (or start time for events with no end time) has passed, don't
      # print it.
      hour="${time:0:2}"
      minute="${time:3:2}"
      
      if [[ $hour -lt $currenthour || ( $hour -eq $currenthour && $minute -lt $currentminute ) ]] ; then
        continue
      fi
    fi
  fi
  echo "$x"
done
IFS=$OIFS
