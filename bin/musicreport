#!/bin/sh
# Scan a folder containing a bunch of OGG-format albums in sub-folders, and produce
# a folder of HTML files, one per genre, with links to each album in MusicBrainz (if
# MB tags are present).

if [ "$1" = "--help" ]; then
  echo "musicreport: create an HTML report of a music library"
  echo ""
  echo "Usage: musicreport"
  exit 1
fi

MUSIC_DIR=/Volumes/share/Music/Library
OUTPUT_DIR=$HOME/Dropbox/Public/Music


rm -f $OUTPUT_DIR/*.html
rm -f $OUTPUT_DIR/*.temp


for album in $MUSIC_DIR/* ; do
  file="$album/`ls "${album}" | grep "ogg$" | head -1`"
  if [[ "$file" = "$album/" ]] ; then
    file="$album/`ls "${album}" | grep "flac$" | head -1`"
    
    if [[ "$file" = "$album/" ]] ; then
      file="$album/`ls "${album}" | grep "mp3$" | head -1`"
      if [[ "$file" = "$album/" ]] ; then
        continue
      fi
      
      echo $file
      mp3info=`eyeD3 --no-color "$file"`
      
      trackartist=`echo "$mp3info" | grep -i "artist: " | sed "s/.*artist: \(.*\)$/\1/"`
      albumartist=$trackartist
      album=`echo "$mp3info" | grep -i "album: " | sed "s/album: \(.*\)year:.*$/\1/" | sed "s/[ 	]*$//"`
      genre=`echo "$mp3info" | grep -i "genre: " | sed "s/.*genre: \(.*\) [(]id .*$/\1/"`
      mb_albumid=`echo "$mp3info" | sed -n -e "/MusicBrainz Album Id/{n;p;}"`
    else
      echo $file
      flacinfo=`metaflac --list "$file"`
      
      trackartist=`echo "$flacinfo" | grep -i " artist=" | cut -d = -f 2-`
      albumartist=`echo "$flacinfo" | grep -i " albumartist=" | cut -d = -f 2-`
      album=`echo "$flacinfo" | grep -i " album=" | cut -d = -f 2-`
      genre=`echo "$flacinfo" | grep -i " genre=" | cut -d = -f 2-`
      mb_albumid=`echo "$flacinfo" | grep -i " musicbrainz_albumid=" | cut -d = -f 2-`
    fi
  else
    echo $file
    ogginfo=`vorbiscomment "$file"`
    
    trackartist=`echo "$ogginfo" | grep -i "^artist=" | cut -d = -f 2-`
    albumartist=`echo "$ogginfo" | grep -i "^albumartist=" | cut -d = -f 2-`
    album=`echo "$ogginfo" | grep -i "^album=" | cut -d = -f 2-`
    genre=`echo "$ogginfo" | grep -i "^genre=" | cut -d = -f 2-`
    mb_albumid=`echo "$ogginfo" | grep -i "^musicbrainz_albumid=" | cut -d = -f 2-`
  fi
  
  if [[ "$genre" = "" ]] ; then
    continue
  fi

  genre_tempfile="$OUTPUT_DIR/$genre.temp"
  
  if [[ "$albumartist" != "" ]] ; then
    artist="$albumartist"
  else
    artist="$trackartist"
  fi
  
  if [[ "$mb_albumid" != "" ]] ; then
    echo "<a href=\"http://musicbrainz.org/release/$mb_albumid.html\">$artist - $album</a><br />" >> $genre_tempfile
  else
    echo "$artist - $album<br />" >> $genre_tempfile
  fi
done

rm -f $OUTPUT_DIR/index.html
echo "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" /><title>Music Listing</title></head><body>" > $OUTPUT_DIR/index.html
echo "<h1>Music Listing</h1>" >> $OUTPUT_DIR/index.html
echo "<p>Last Updated: `date +%D`</p>" >> $OUTPUT_DIR/index.html
echo "<ul>" >> $OUTPUT_DIR/index.html

for tempfile in $OUTPUT_DIR/*.temp ; do
  genre=`basename "$tempfile" .temp`
  htmlfile="$OUTPUT_DIR/$genre.html"
  
  echo "<li><a href=\"$genre.html\">$genre</a></li>" >> $OUTPUT_DIR/index.html
  
  rm -f $htmlfile
  echo "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" /><title>" > $htmlfile
  echo "Music Listing for $genre" >> $htmlfile
  echo "</title></head><body><h1>Music Listing for $genre:</h1><p>" >> $htmlfile
  cat "$tempfile" >> $htmlfile
  echo "</p></body></html>" >> $htmlfile
done

echo "</ul></body></html>" >> $OUTPUT_DIR/index.html

rm $OUTPUT_DIR/*.temp
