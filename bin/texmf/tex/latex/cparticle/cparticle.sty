\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cparticle}[2009/10/25 C. Pence Article Template]
\RequirePackage{xkeyval}

% Options
\define@boolkey{cparticle.sty}[CPA@]{geometry}[true]{}
\define@boolkey{cparticle.sty}[CPA@]{hyperlink}[true]{}
\presetkeys{cparticle.sty}{geometry=true,hyperlink=true}{}
\ProcessOptionsX

% Include hyperref, some of my bibliography styles use it
\ifCPA@hyperlink
  \usepackage{hyperref}
  \hypersetup{
    xetex,
    colorlinks,
    breaklinks,
    citecolor=black,
    linkcolor=black,
    filecolor=black,
    menucolor=black,
    urlcolor=blue
  }
\fi

% AMS
\RequirePackage{amssymb}
\RequirePackage{amsmath}
\RequirePackage{amsthm}

% XeLaTeX
\RequirePackage{fontspec}
\RequirePackage{unicode-math}

% Fonts
\defaultfontfeatures{Ligatures=Common,Mapping=tex-text}
\setmainfont{Gentium Book Basic}
\setsansfont[Scale=MatchLowercase,LetterSpace=-1.8]{Lucida Sans}
\setmonofont[Scale=MatchUppercase]{Droid Sans Mono}

% Math
\setmathfont{euler.otf}
% Map italic back to upright, since Euler doesn't have italics
\setmathfont[range=\mathit/{greek,Greek,latin,Latin}->\mathup]{euler.otf}

% Page
\ifCPA@geometry
  \usepackage[letterpaper,hmargin=1in,vmargin=1in]{geometry}
\fi

% Spacing
\frenchspacing
\RequirePackage{setspace}
\RequirePackage{calc}
\newlength{\cpaskip}
\newcounter{cpatemp}

\usepackage{printlen}

\renewenvironment{quote}{%
\list{}{\rightmargin\leftmargin}%
\let\cpastretch\baselinestretch%
%\setcounter{cpatemp}{500*\real{\baselinestretch}-500}%
\setlength{\cpaskip}{\baselineskip*\value{cpatemp}/1000}%
\setstretch{1.0}%
\item\relax}
{\endlist\setstretch{\cpastretch}\vspace{-\cpaskip}}

\def\changemargin#1#2{%
\let\cpastretch\baselinestretch%
%\setcounter{cpatemp}{500*\real{\baselinestretch}-500}%
\setlength{\cpaskip}{\baselineskip*\value{cpatemp}/1000}%
\list{}{\rightmargin#2\leftmargin#1}\setstretch{1.0}\item[]}
\def\endchangemargin{\endlist\setstretch{\cpastretch}\vspace{-\cpaskip}}

\setlength{\parindent}{2\baselineskip}


% Bibliography
\usepackage{natbib}
\setcitestyle{authoryear,round,sort}
\let\cite=\citet
\renewcommand{\bibsection}{\section*{\bibname}\setstretch{1.0}}

% Footnotes
\RequirePackage{hanging}
\RequirePackage{settobox}
\newsavebox{\cpafnotemark}
\newlength{\cpafnote}
% This is almost the same as the 'hangparas' environment, but 'hangparas'
% has some whitespace in its definition, which causes the insertion of a space
% that destroys the precise alignment that I'm building here.  So I redefine
% 'hangparas' as 'cpafootnote'.
\newenvironment{cpafootnote}[2]{\setlength{\parindent}{1em}\everypar={\hangpara{#1}{#2}}}{\par}
\renewcommand\@makefntext[1]{%
    \sbox{\cpafnotemark}{\@thefnmark.\hspace{0.5ex}}
    \settoboxwidth{\cpafnote}{\cpafnotemark}
    \noindent\usebox{\cpafnotemark}\begin{cpafootnote}{\cpafnote}{0}\hangpara{\cpafnote}{1}#1\end{cpafootnote}}


% Section Headers
\newcommand{\runinhead}[1]{\emph{#1.}\hspace{1em}}

\RequirePackage[tiny,sf]{titlesec}
\titleformat{\section}[hang]
  {\normalsize\bfseries\sffamily}
  {\thesection.}
  {0.5em}
  {}
\titleformat{\subsection}[hang]
  {\normalsize\sffamily}
  {\thesubsection.}
  {0.5em}
  {}
\titleformat{\subsubsection}[hang]
  {\normalsize\sffamily\itshape}
  {{\upshape\thesubsubsection.}}
  {0.5em}
  {}


\endinput
