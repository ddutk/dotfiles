#!/usr/bin/perl
# getBibTeXFromZotero - get a bibtex file with all references from Zotero
#                       using MozRepl
#
# Requires installation of MozRepl from CPAN, Firefox, Zotero, and MozRepl
#                          firefox extension.
#
# The bibtex file will be output to stdout

use strict;
use warnings;

use MozRepl;

# temporary file to store bibliography
my $filename = "/tmp/export-zotero.bib";

my $repl = MozRepl->new;
# Make it quiet
$repl->setup_log([qw/error fatal/]);
$repl->setup;
my $executestring = "filename = '$filename';";
$executestring .= q|var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
file.initWithPath(filename);
var zotero = Components.classes['@zotero.org/Zotero;1'].getService(Components.interfaces.nsISupports).wrappedJSObject;
var translatorObj = new Zotero.Translate('export');
translatorObj.setLocation(file);
translatorObj.setTranslator('9cb70025-a888-4a29-a210-93ec52da40d4');
translatorObj.translate();|;

$repl->execute($executestring);

# print to stdout
open(FH, $filename) or die "Can't open $filename: $!";
foreach(<FH>){
print;
}
print "\n";
close(FH);
# delete the temporary file
unlink($filename);
