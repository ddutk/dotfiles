#!/bin/sh
# Scan a folder containing:
#   Movie (year)/Movie.nfo
# subolders, and produce an HTML file with links to each movie in IMDB.

if [ "$1" = "--help" ]; then
  echo "moviereport: create an HTML report of a movie library"
  echo ""
  echo "Usage: moviereport"
  exit 1
fi

MOVIE_DIR=/Volumes/share/Movies
OUTPUT_DIR=$HOME/Dropbox/Charles/Documents/Website/input/movies


rm -f $OUTPUT_DIR/*.html
rm -f $OUTPUT_DIR/*.temp


for movie in $MOVIE_DIR/* ; do
  title=`echo $movie | sed "s@$MOVIE_DIR/*@@" | sed "s@ [(][0-9][0-9][0-9][0-9][)]\\$@@"`
  year=`echo $movie | sed "s@.*\([(][0-9][0-9][0-9][0-9][)]\)\\$@\1@"`
  
  nfofile="$movie/`ls "${movie}" | grep "nfo$" | head -1`"
  if [[ ! -e $nfofile ]] ; then
    echo "WARNING: No .NFO file for movie $title $year!"
    continue
  fi
  
  id=`cat "$nfofile" | grep "^[ 	]*<id>"`
  set=`cat "$nfofile" | grep "^[ 	]*<set>"`
  
  if [[ "$set" != "" ]]; then
    set=`echo $set | sed "s@^.*<set>\(.*\)</set>.*\\$@\1@"`
  fi

  if [[ "$id" != "" ]]; then
    id=`echo $id | sed "s@^.*<id>\(.*\)</id>.*\\$@\1@"`
  fi

  # Those sed commands might *make* id and set empty, so re-check

  # This is a crafty hack to make sorting work
  if [[ "$set" != "" ]]; then
    echo -n "<!-- $set: $title -->" >> $OUTPUT_DIR/index.temp
  else
    echo -n "<!-- $title -->" >> $OUTPUT_DIR/index.temp
  fi

  if [[ "$id" != "" ]]; then
    echo -n "<a href=\"http://www.imdb.com/title/$id/\">" >> $OUTPUT_DIR/index.temp
  fi
  if [[ "$set" != "" ]]; then
    echo -n "$set: " >> $OUTPUT_DIR/index.temp
  fi
  echo -n "$title $year" >> $OUTPUT_DIR/index.temp
  if [[ "$id" != "" ]]; then
    echo -n "</a>" >> $OUTPUT_DIR/index.temp
  fi
  echo "<br />" >> $OUTPUT_DIR/index.temp
done

rm -f $OUTPUT_DIR/index.html
echo "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" /><title>Movie Listing</title></head><body>" > $OUTPUT_DIR/index.html
echo "<h1>Movie Listing</h1>" >> $OUTPUT_DIR/index.html
echo "<p>Last Updated: `date +%D`</p>" >> $OUTPUT_DIR/index.html
echo "<p>" >> $OUTPUT_DIR/index.html

cat $OUTPUT_DIR/index.temp | sort >> $OUTPUT_DIR/index.html

echo "</p></body></html>" >> $OUTPUT_DIR/index.html

rm $OUTPUT_DIR/index.temp

